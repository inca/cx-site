
<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" media="screen, projection" href="/css/main.css" />
  <link rel="stylesheet" media="screen, projection" href="/css/colorbox.css" />
  <link rel="stylesheet" href="/css/menu_navigation.css" />
  <link rel="stylesheet" media="print" href="/css/print.css" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <meta name="google-site-verification" content="8igpdSJ4tgF2EKKuvmA5GOWzRLKHozE5Aun82c5NQZY" />
  <meta name='yandex-verification' content='443ed98406777aa4' />
  <meta name='yandex-verification' content='59d4a20bb51bbfea' />
  <script type="text/javascript" src="http://www.google-analytics.com/ga.js">
  </script>
  <script src="/js/highlight.pack.js"></script>
  <script src="/js/jquery-1.4.2.min.js"></script>
  <script src="/js/jquery.colorbox-min.js"></script>
  <script src="/js/application.js"></script>
  <script src="/js/menu.js"></script> 
    <title>
        Circumflex &mdash; exquisite taste of Scala development
  </title>
</head>
<body>
<div id="header">
  <div class="wrap">
    <h1>
      <a href="/" title="Home">C&icirc;rcumflex</a>
    </h1>
    <span class="aside">exquisite taste of <a href="http://scala-lang.org">Scala</a> development</span>
  </div>
</div>
<div id="slidemenu" class="slidemenu">
  <ul>
    <li>
      <a href="/products.html">Products</a>
      <ul>
        <li>
          <a href="/products/web/index.html">Web Framework</a>
          <ul>
            <li><a href="/products/web/index.html">About</a></li>
            <li><a href="/products/web/install_config.html">Quick Start</a></li>
            <li><a href="api/2.0/circumflex-web/src/main/scala/package.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=web">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/products/orm/index.html">ORM</a>
          <ul>
            <li><a href="/products/orm/index.html">About</a></li>
            <li><a href="/products/orm/install_config.html">Quick Start</a></li>
            <li><a href="/api/2.0/circumflex-orm/src/main/scala/package.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=orm">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/products/ftl/index.html">FreeMarker Helper</a>
          <ul>
            <li><a href="/products/ftl/index.html">About</a></li>
            <li><a href="/products/ftl/qs.html">Quick Start</a></li>
            <li><a href="/api/2.0/circumflex-ftl/src/main/scala/package.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=ftl">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/products/me/index.html">Markeven</a>
          <ul>
            <li><a href="/products/me/index.html">About</a></li>
            <li><a href="/products/me/syntax.html">Syntax</a></li>
            <li><a href="/products/me">Try it</a></li>
            <li><a href="/products/me/qs.html">Quick Start</a></li>
            <li><a href="/api/2.0/circumflex-markeven/src/main/scala/package.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=me">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/products/scalate/index.html">Scalate</a>
          <ul>
            <li><a href="/products/scalate/index.html">About</a></li>
            <li><a href="/products/scalate/qs.html">Quick Start</a></li>
            <li><a href="/api/2.0/circumflex-scalate/src/main/scala/package.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=scalate">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/products/docco/index.html">Docco</a>
          <ul>
            <li><a href="/products/docco/index.html">About</a></li>
            <li><a href="/products/docco/qs.html">Quick Start</a></li>
            <li><a href="/api/2.0/circumflex-docco/src/main/scala/docco.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=docco">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/plugin.html">Plugin</a>
          <ul>
            <li><a href="/plugin.html">About</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=cx-plugin">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li>
      <a href="/products/web/index.html" Web>Web</a>
      <ul>
        <li><a href="/products/web/index.html">About</a></li>
        <li><a href="/products/web/install_config.html">Installation & Configuration</a></li>
        <li>
          <a href="/products/web/basic_concepts">Basic concepts</a>
          <ul>
            <li><a href="/products/web/basic_concepts#routers">Request routers</a></li>
            <li><a href="/products/web/basic_concepts#routes">Routes</a></li>
            <li><a href="/products/web/basic_concepts#matchers">Matchers</a></li>
            <li><a href="/products/web/basic_concepts#params">Parameters</a></li>
            <li><a href="/products/web/basic_concepts#static">Serving Static files</a></li>
            <li><a href="/products/web/basic_concepts#redirect-rewrite">Redirecting & Forwarding</a></li>
            <li><a href="/products/web/basic_concepts#errors">Sending Errors</a></li>
            <li><a href="/products/web/basic_concepts#send-file">Sending Files</a></li>
            <li><a href="/products/web/basic_concepts#xhr">Handling AJAX Requests</a></li>
            <li><a href="/products/web/basic_concepts#headers">Accessing Headers</a></li>
            <li><a href="/products/web/basic_concepts#session">Accessing Session</a></li>
            <li><a href="/products/web/basic_concepts#flashes">Flashes</a></li>
          </ul>
        </li>
        <li>
          <a href="/products/web/advanced_concepts.html">Advanced concepts</a>
          <ul>
            <li><a href="/products/web/advanced_concepts.html#adv-matching">Matching</a></li>
            <li><a href="/products/web/advanced_concepts.html#prefix">Router Prefix</a></li>
          </ul>
        </li>
        <li><a href="/products/web/full.html">Full article</a></li>
      </ul>
    </li>
    <li>
      <a href="/products/orm/index.html">ORM</a>
      <ul>
        <li><a href="/products/orm/index">About</a></li>
        <li><a href="/products/orm/install_config.html">Installation & Configuration</a></li>
        <li>
          <a href="/products/orm/ddl/index.html">Data Definition Language</a>
          <ul>
            <li><a href="/products/orm/ddl/central_abstractions">Central Abstractions</a></li>
            <li><a href="/products/orm/ddl/part_1.html">Record & Relations</a></li>
            <li>
              <a href="/products/orm/ddl/part_2.html">More about Fields</a>
              <ul>
                <li><a href="/products/orm/ddl/part_2.html#idgen">Generating Identifiers</a></li>
                <li><a href="/products/orm/ddl/part_2.html#association">Associations</a></li>
                <li><a href="/products/orm/ddl/part_2.html#validation">Validation</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="/products/orm/exporting_schema.html">Exporting Database Schema</a></li>
        <li>
          <a href="/products/orm/querying/index.html">Querying</a>
          <ul>
            <li><a href="/products/orm/querying/select.html">Select Queries</a></li>
            <li><a href="/products/orm/querying/part_1.html">Table Alias and Projections</a></li>
            <li><a href="/products/orm/querying/part_2.html">Predicates</a></li>
            <li><a href="/products/orm/querying/part_3.html">Joins</a></li>
            <li><a href="/products/orm/querying/part_4.html">Ordering, Grouping & Limiting</a></li>
            <li><a href="/products/orm/querying/part_5.html">Union, Intersect & Except</a></li>
            <li><a href="/products/orm/querying/reusing">Reusing Query Objects</a></li>
            <li><a href="/products/orm/querying/part_6.html">Criteria API</a></li>
          </ul>
        </li>
        <li>
          <a href="/products/orm/dml.html">Data Manipulation</a>
          <ul>
            <li><a href="/products/orm/dml.html#iud">Insert, Update & Delete</a></li>
            <li><a href="/products/orm/dml.html#save">Save</a></li>
            <li>
              <a href="/products/orm/dml.html#bulk">Bulk Queries</a>
              <ul>
                <a href="/products/orm/dml.html#insert-select">Insert-Select</a>
                <a href="/products/orm/dml.html#update-delete">Update & Delete</a>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="/products/orm/full.html">Full article</a></li>
      </ul>
    </li>
    <li>
      <a href="/downloads?file=full">Download</a>
      <ul>
        <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
        <li><a href="/download?file=full">All components</a></li>
        <li><a href="/download?file=web">Web Framework</a></li>
        <li><a href="/download?file=orm">ORM</a></li>
        <li><a href="/download?file=ftl">FreeMarker Helper</a></li>
        <li><a href="/download?file=me">Markeven</a></li>
        <li><a href="/download?file=scalate">Scalate</a></li>
        <li><a href="/download?file=docco">Docco</a></li>
        <li><a href="/download?file=cx-plugin">Plugin</a></li>
      </ul>
    </li>
    <li><a href="/quick_start.html">Quick Start</a></li>
    <li><a href="/api">Documentation</a></li>
  </ul>
  <br style="clear: left"/>
</div><div id="docco-page">
  <h1 id="docco-back">
    <a href="../../../../index.html" title="Back to index">&larr;</a>&nbsp;&nbsp;xml.scala
  </h1>
  <table cellspacing="0" cellpadding="0">
    <tbody>
      <tr id="section-0">
        <td class="docs">
          
        </td>
        <td class="code">
          <pre class="scala"><code>package ru.circumflex.orm

import ru.circumflex.core._
import xml._
import java.io.File</code></pre>
        </td>
      </tr>
      <tr id="section-1">
        <td class="docs">
          <h1>XML (de)serialization</h1>
<p>Circumflex ORM allows you to load graphs of associated records from XML files. This is very useful for loading test data and exchanging records between databases with associations preserving (in id-independent style).</p>
<p>Every <code>Field</code> capable of (de)serializing itself (from)into XML should extend the <code>XmlSerializable</code> trait. A record can be read from XML format if it contains only <code>XmlSerializable</code> fields.</p>

        </td>
        <td class="code">
          <pre class="scala"><code>abstract class XmlSerializable[T, R &lt;: Record[_, R]](
    name: String, record: R, sqlType: String)
    extends Field[T, R](name, record, sqlType) {
  def from(str: String): Option[T]
  def to(value: Option[T]): String =
    value.map(_.toString).getOrElse(&quot;&quot;)
}</code></pre>
        </td>
      </tr>
      <tr id="section-2">
        <td class="docs">
          <p>Deployment is a unit of work of XML import tool. It specifies the <code>prefix</code> for record classes resolution, the <code>onExist</code> behavior (<code>keep</code>, <code>update</code> or <code>recreate</code>) and whether record validation is needed before persisting. One deployment corresponds to one transaction, so each deployment is executed atomically.</p>

        </td>
        <td class="code">
          <pre class="scala"><code>class Deployment(val id: String,
                 val prefix: String,
                 val onExist: Deployment.OnExistAction,
                 val validate: Boolean = true,
                 val entries: Seq[Node]) {

  def process(): Unit = try {
    entries.foreach(e =&gt; processNode(e, Nil))
    COMMIT
  } catch {
    case e =&gt;
      ROLLBACK
      throw e
  }

  protected def processNode[R &lt;: Record[Any, R]](
      node: Node,
      parentPath: Seq[Pair[Association[_, _, _], Record[_, _]]]): Record[Any, R] = {
    val cl = pickClass(node)
    var r = cl.newInstance.asInstanceOf[R]
    var update = false
    // Decide, whether a record should be processed, and how exactly.
    if (node.attributes.next != null) {
      val crit = prepareCriteria(r, node)
      crit.unique match {
        case Some(rec: R) if (onExist == Deployment.Skip || node.child.size == 0) =&gt;
          return rec
        case Some(rec: R) if (onExist == Deployment.Recreate) =&gt;
          crit.mkDelete.execute()
        case Some(rec: R) if (onExist == Deployment.Update) =&gt;
          r = rec
          update = true
        case _ =&gt;
      }
    }
    // If we are still here, let's process the record further.
    // In first place, we set provided parents
    parentPath.foreach { p =&gt;
      if (r.relation.fields.contains(p._1.field))
        r.relation.getField(r, p._1.field.asInstanceOf[Field[Any, R]]).set(p._2.PRIMARY_KEY.value)
    }
    var foreigns: Seq[Pair[Association[_, _, _], Node]] = Nil
    // Secondly, we set fields provided via attributes
    node.attributes.foreach(a =&gt; setRecordField(r, a.key, a.value.toString))
    // Next we process element body
    node.child.foreach {
      case n: Elem =&gt; try {
        r.getClass.getMethod(n.label) match {
          case m if (classOf[Field[_, _]].isAssignableFrom(m.getReturnType)) =&gt;
            setRecordField(r, n.label, n.child.mkString.trim)
          case m if (classOf[Association[_, _, _]].isAssignableFrom(m.getReturnType)) =&gt;
            val a = m.invoke(r).asInstanceOf[Association[Any, R, R]]
            val newPath = parentPath ++ List(a -&gt; r)
            val parent = if (n.child.size == 0) {
              val newNode = Elem(null, a.parentRelation.recordClass.getSimpleName, n.attributes, n.scope)
              Some(processNode(newNode, newPath))
            } else n.child.find(_.isInstanceOf[Elem]).map(n =&gt; processNode(n, newPath))
            r.relation.getField(r, a.field).set(parent.map(_.PRIMARY_KEY.value))
          case m if (classOf[InverseAssociation[_, _, _, _]].isAssignableFrom(m.getReturnType)) =&gt;
            val a = m.invoke(r).asInstanceOf[InverseAssociation[Any, R, R, Any]].association
            foreigns ++= n.child.filter(_.isInstanceOf[Elem]).map(n =&gt; (a -&gt; n))
        }
      } catch {
        case e: NoSuchMethodException =&gt;
          ORM_LOG.warn(&quot;Could not process '&quot; + n.label + &quot;' of &quot; + r.getClass)
      }
      case _ =&gt;
    }
    // Now the record is ready to be saved
    if (update)
      if (validate) r.UPDATE() else r.UPDATE_!()
    else
    if (validate) r.INSERT() else r.INSERT_!()
    // Finally, we process the foreigners
    foreigns.foreach(p =&gt;
      processNode(p._2, parentPath ++ List(p._1.asInstanceOf[Association[Any, R, R]] -&gt; r)))
    // And return our record
    return r
  }

  protected def pickClass(node: Node): Class[_] = {
    var p = &quot;&quot;
    if (prefix != &quot;&quot;) p = prefix + &quot;.&quot;
    return Class.forName(p + node.label, true, Thread.currentThread().getContextClassLoader())
  }

  protected def setRecordField[R &lt;: Record[_, R]](r: R, k: String, v: String): Unit = {
    val m = r.getClass.getMethod(k)
    if (classOf[Field[_, _]].isAssignableFrom(m.getReturnType)) {    // only scalar fields are accepted
      val field = m.invoke(r).asInstanceOf[Field[Any, R]]
      val value = convertValue(field, v)
      field.set(value)
    }
  }

  protected def prepareCriteria[R &lt;: Record[Any, R]](r: R, n: Node): Criteria[Any, R] = {
    val crit = r.relation.AS(&quot;root&quot;).criteria
    n.attributes.foreach(a =&gt; {
      val k = a.key
      val field = r.relation.getClass.getMethod(k).invoke(r).asInstanceOf[Field[Any, R]]
      val v = convertValue(field, a.value.toString)
      ctx(&quot;orm.lastAlias&quot;) = &quot;root&quot;
      crit.add(field EQ v)
    })
    return crit
  }

  protected def convertValue(field: Field[Any, _], v: String): Option[Any] = field match {
    case field: XmlSerializable[Any, _] =&gt; field.from(v)
    case _ =&gt; Some(v)
  }

  override def toString = id match {
    case &quot;&quot; =&gt; &quot;deployment@&quot; + hashCode
    case _ =&gt; id
  }

}

object Deployment {

  trait OnExistAction
  object Skip extends OnExistAction
  object Update extends OnExistAction
  object Recreate extends OnExistAction

  def readOne(n: Node): Deployment = if (n.label == &quot;deployment&quot;) {
    val id = (n \ &quot;@id&quot;).text
    val prefix = (n \ &quot;@prefix&quot;).text
    val onExist = (n \ &quot;@onExist&quot;).text match {
      case &quot;keep&quot; | &quot;ignore&quot; | &quot;skip&quot; =&gt; Deployment.Skip
      case &quot;update&quot; =&gt; Deployment.Update
      case &quot;recreate&quot; | &quot;delete&quot; | &quot;delete-create&quot; | &quot;overwrite&quot; =&gt; Deployment.Recreate
      case _ =&gt; Deployment.Skip
    }
    val validate = (n \ &quot;@validate&quot;).text match {
      case &quot;false&quot; | &quot;f&quot; | &quot;no&quot; | &quot;off&quot; =&gt; false
      case _ =&gt; true
    }
    return new Deployment(id, prefix, onExist, validate, n.child.filter(n =&gt; n.isInstanceOf[Elem]))
  } else throw new ORMException(&quot;&lt;deployment&gt; expected, but &lt;&quot; + n.label + &quot;&gt; found.&quot;)

  def readAll(n: Node): Seq[Deployment] = if (n.label == &quot;deployments&quot;)
    (n \ &quot;deployment&quot;).map(n =&gt; readOne(n))
  else throw new ORMException(&quot;&lt;deployments&gt; expected, but &quot; + n.label + &quot; found.&quot;)

}

class DeploymentHelper(f: File) {
  def loadData(): Unit = Deployment.readAll(XML.loadFile(f)).foreach(_.process)
}</code></pre>
        </td>
      </tr>
  </table>
</div>

<div id="footer">
  <p><span>Copyright 2009-2010 <a href="http://circumflex.ru">circumflex.ru</a></span></p>
  <p><a href="/license.html">Terms <span class="amp">&amp;</span> conditions</a> apply &bull;
    <a href="/credits.html">credits</a></p>
</div>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-12034468-1");
    pageTracker._setDomainName(".circumflex.ru");
    pageTracker._trackPageview();
  } catch(err) {}</script>
</body>
</html>

