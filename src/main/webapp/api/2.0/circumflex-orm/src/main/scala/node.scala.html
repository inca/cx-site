
<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" media="screen, projection" href="/css/main.css" />
  <link rel="stylesheet" media="screen, projection" href="/css/colorbox.css" />
  <link rel="stylesheet" href="/css/menu_navigation.css" />
  <link rel="stylesheet" media="print" href="/css/print.css" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <meta name="google-site-verification" content="8igpdSJ4tgF2EKKuvmA5GOWzRLKHozE5Aun82c5NQZY" />
  <meta name='yandex-verification' content='443ed98406777aa4' />
  <meta name='yandex-verification' content='59d4a20bb51bbfea' />
  <script type="text/javascript" src="http://www.google-analytics.com/ga.js">
  </script>
  <script src="/js/highlight.pack.js"></script>
  <script src="/js/jquery-1.4.2.min.js"></script>
  <script src="/js/jquery.colorbox-min.js"></script>
  <script src="/js/application.js"></script>
  <script src="/js/menu.js"></script> 
    <title>
        Circumflex &mdash; exquisite taste of Scala development
  </title>
</head>
<body>
<div id="header">
  <div class="wrap">
    <h1>
      <a href="/" title="Home">C&icirc;rcumflex</a>
    </h1>
    <span class="aside">exquisite taste of <a href="http://scala-lang.org">Scala</a> development</span>
  </div>
</div>
<div id="slidemenu" class="slidemenu">
  <ul>
    <li>
      <a href="/products.html">Products</a>
      <ul>
        <li>
          <a href="/products/web/index.html">Web Framework</a>
          <ul>
            <li><a href="/products/web/index.html">About</a></li>
            <li><a href="/products/web/install_config.html">Quick Start</a></li>
            <li><a href="api/2.0/circumflex-web/src/main/scala/package.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=web">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/products/orm/index.html">ORM</a>
          <ul>
            <li><a href="/products/orm/index.html">About</a></li>
            <li><a href="/products/orm/install_config.html">Quick Start</a></li>
            <li><a href="/api/2.0/circumflex-orm/src/main/scala/package.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=orm">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/products/ftl/index.html">FreeMarker Helper</a>
          <ul>
            <li><a href="/products/ftl/index.html">About</a></li>
            <li><a href="/products/ftl/qs.html">Quick Start</a></li>
            <li><a href="/api/2.0/circumflex-ftl/src/main/scala/package.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=ftl">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/products/me/index.html">Markeven</a>
          <ul>
            <li><a href="/products/me/index.html">About</a></li>
            <li><a href="/products/me/syntax.html">Syntax</a></li>
            <li><a href="/products/me">Try it</a></li>
            <li><a href="/products/me/qs.html">Quick Start</a></li>
            <li><a href="/api/2.0/circumflex-markeven/src/main/scala/package.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=me">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/products/scalate/index.html">Scalate</a>
          <ul>
            <li><a href="/products/scalate/index.html">About</a></li>
            <li><a href="/products/scalate/qs.html">Quick Start</a></li>
            <li><a href="/api/2.0/circumflex-scalate/src/main/scala/package.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=scalate">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/products/docco/index.html">Docco</a>
          <ul>
            <li><a href="/products/docco/index.html">About</a></li>
            <li><a href="/products/docco/qs.html">Quick Start</a></li>
            <li><a href="/api/2.0/circumflex-docco/src/main/scala/docco.scala.html">Documentation</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=docco">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="/plugin.html">Plugin</a>
          <ul>
            <li><a href="/plugin.html">About</a></li>
            <li>
              <a href="#">Download</a>
              <ul>
                <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
                <li><a href="/download?file=cx-plugin">Package</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li>
      <a href="/products/web/index.html" Web>Web</a>
      <ul>
        <li><a href="/products/web/index.html">About</a></li>
        <li><a href="/products/web/install_config.html">Installation & Configuration</a></li>
        <li>
          <a href="/products/web/basic_concepts">Basic concepts</a>
          <ul>
            <li><a href="/products/web/basic_concepts#routers">Request routers</a></li>
            <li><a href="/products/web/basic_concepts#routes">Routes</a></li>
            <li><a href="/products/web/basic_concepts#matchers">Matchers</a></li>
            <li><a href="/products/web/basic_concepts#params">Parameters</a></li>
            <li><a href="/products/web/basic_concepts#static">Serving Static files</a></li>
            <li><a href="/products/web/basic_concepts#redirect-rewrite">Redirecting & Forwarding</a></li>
            <li><a href="/products/web/basic_concepts#errors">Sending Errors</a></li>
            <li><a href="/products/web/basic_concepts#send-file">Sending Files</a></li>
            <li><a href="/products/web/basic_concepts#xhr">Handling AJAX Requests</a></li>
            <li><a href="/products/web/basic_concepts#headers">Accessing Headers</a></li>
            <li><a href="/products/web/basic_concepts#session">Accessing Session</a></li>
            <li><a href="/products/web/basic_concepts#flashes">Flashes</a></li>
          </ul>
        </li>
        <li>
          <a href="/products/web/advanced_concepts.html">Advanced concepts</a>
          <ul>
            <li><a href="/products/web/advanced_concepts.html#adv-matching">Matching</a></li>
            <li><a href="/products/web/advanced_concepts.html#prefix">Router Prefix</a></li>
          </ul>
        </li>
        <li><a href="/products/web/full.html">Full article</a></li>
      </ul>
    </li>
    <li>
      <a href="/products/orm/index.html">ORM</a>
      <ul>
        <li><a href="/products/orm/index">About</a></li>
        <li><a href="/products/orm/install_config.html">Installation & Configuration</a></li>
        <li>
          <a href="/products/orm/ddl/index.html">Data Definition Language</a>
          <ul>
            <li><a href="/products/orm/ddl/central_abstractions">Central Abstractions</a></li>
            <li><a href="/products/orm/ddl/part_1.html">Record & Relations</a></li>
            <li>
              <a href="/products/orm/ddl/part_2.html">More about Fields</a>
              <ul>
                <li><a href="/products/orm/ddl/part_2.html#idgen">Generating Identifiers</a></li>
                <li><a href="/products/orm/ddl/part_2.html#association">Associations</a></li>
                <li><a href="/products/orm/ddl/part_2.html#validation">Validation</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="/products/orm/exporting_schema.html">Exporting Database Schema</a></li>
        <li>
          <a href="/products/orm/querying/index.html">Querying</a>
          <ul>
            <li><a href="/products/orm/querying/select.html">Select Queries</a></li>
            <li><a href="/products/orm/querying/part_1.html">Table Alias and Projections</a></li>
            <li><a href="/products/orm/querying/part_2.html">Predicates</a></li>
            <li><a href="/products/orm/querying/part_3.html">Joins</a></li>
            <li><a href="/products/orm/querying/part_4.html">Ordering, Grouping & Limiting</a></li>
            <li><a href="/products/orm/querying/part_5.html">Union, Intersect & Except</a></li>
            <li><a href="/products/orm/querying/reusing">Reusing Query Objects</a></li>
            <li><a href="/products/orm/querying/part_6.html">Criteria API</a></li>
          </ul>
        </li>
        <li>
          <a href="/products/orm/dml.html">Data Manipulation</a>
          <ul>
            <li><a href="/products/orm/dml.html#iud">Insert, Update & Delete</a></li>
            <li><a href="/products/orm/dml.html#save">Save</a></li>
            <li>
              <a href="/products/orm/dml.html#bulk">Bulk Queries</a>
              <ul>
                <a href="/products/orm/dml.html#insert-select">Insert-Select</a>
                <a href="/products/orm/dml.html#update-delete">Update & Delete</a>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="/products/orm/full.html">Full article</a></li>
      </ul>
    </li>
    <li>
      <a href="/download?file=full">Download</a>
      <ul>
        <li><a href="https://github.com/inca/circumflex">GitHub</a></li>
        <li><a href="/download?file=full">All components</a></li>
        <li><a href="/download?file=web">Web Framework</a></li>
        <li><a href="/download?file=orm">ORM</a></li>
        <li><a href="/download?file=ftl">FreeMarker Helper</a></li>
        <li><a href="/download?file=me">Markeven</a></li>
        <li><a href="/download?file=scalate">Scalate</a></li>
        <li><a href="/download?file=docco">Docco</a></li>
        <li><a href="/download?file=cx-plugin">Plugin</a></li>
      </ul>
    </li>
    <li><a href="/quick_start.html">Quick Start</a></li>
    <li><a href="/api">Documentation</a></li>
  </ul>
  <br style="clear: left"/>
</div><div id="docco-page">
  <h1 id="docco-back">
    <a href="../../../../index.html" title="Back to index">&larr;</a>&nbsp;&nbsp;node.scala
  </h1>
  <table cellspacing="0" cellpadding="0">
    <tbody>
      <tr id="section-0">
        <td class="docs">
          
        </td>
        <td class="code">
          <pre class="scala"><code>package ru.circumflex.orm

import java.lang.String</code></pre>
        </td>
      </tr>
      <tr id="section-1">
        <td class="docs">
          <h1>Relation Nodes</h1>
<p>The <code>RelationNode</code> is essentially a wrapper around relation which provides an <code>alias</code> so that it can participate in complex SQL query plans.</p>
<p>Generally a relation node is created implicitly from <code>Relation</code>. A special alias <code>this</code> is assigned to new relation nodes, it is transformed inside queries into a query-unique alias so that no collisions occur.</p>
<p>You may assign an alias explicitly using the <code>AS</code> method.</p>

        </td>
        <td class="code">
          <pre class="scala"><code>class RelationNode[PK, R &lt;: Record[PK, R]](val relation: Relation[PK, R])
    extends SQLable with Cloneable with Equals {

  protected var _alias: String = &quot;this&quot;
  def alias = _alias
  def AS(alias: String): this.type = {
    this._alias = alias
    return this
  }</code></pre>
        </td>
      </tr>
      <tr id="section-2">
        <td class="docs">
          <p>Relation nodes allow Scala-like syntactic sugar by using the <code>map</code> method. Following example gives table <code>City</code> an alias <code>ci</code> and uses it to construct a <code>Criteria</code> object.</p>
<pre><code>(City AS "ci").map(ci =&gt; ci.criteria.add(ci.name LIKE "Lausanne")).list</code></pre>

        </td>
        <td class="code">
          <pre class="scala"><code>  def map[T](f: RelationNode[PK, R] =&gt; T): T = f(this)</code></pre>
        </td>
      </tr>
      <tr id="section-3">
        <td class="docs">
          <p>The <code>*</code> method creates a <code>RecordProjection</code> from this node and is widely used in the <code>SELECT</code> clause of SQL queries.</p>

        </td>
        <td class="code">
          <pre class="scala"><code>  def * = new RecordProjection[PK, R](this)</code></pre>
        </td>
      </tr>
      <tr id="section-4">
        <td class="docs">
          <p>Each relation node define which projection it yields. When nodes are joined the resulting node contains projections from both nodes.</p>

        </td>
        <td class="code">
          <pre class="scala"><code>  def projections: Seq[Projection[_]] = List(*)</code></pre>
        </td>
      </tr>
      <tr id="section-5">
        <td class="docs">
          <p>Creates new <code>Criteria</code> instance with this node as its query plan root.</p>

        </td>
        <td class="code">
          <pre class="scala"><code>  def criteria = new Criteria[PK, R](this)</code></pre>
        </td>
      </tr>
      <tr id="section-6">
        <td class="docs">
          <p>Relation nodes can be joined to allow restrictions of associated relations.</p>

        </td>
        <td class="code">
          <pre class="scala"><code>  def findAssociation[T, F &lt;: Record[T, F]](node: RelationNode[T, F]): Option[Association[T, R, F]] =
    this.relation.findAssociation(node.relation)

  def JOIN[T, J &lt;: Record[T, J]](node: RelationNode[T, J],
                                 on: String,
                                 joinType: JoinType): JoinNode[PK, R, T, J] =
    new JoinNode(this, node, joinType).ON(on)
  def JOIN[T, J &lt;: Record[T, J]](node: RelationNode[T, J],
                                 joinType: JoinType = LEFT): JoinNode[PK, R, T, J] =
    findAssociation(node) match {
      case Some(a: Association[T, R, J]) =&gt;  // many-to-one join
        new ManyToOneJoin[PK, R, T, J](this, node, a, joinType)
      case _ =&gt; node.findAssociation(this) match {
        case Some(a: Association[PK, J, R]) =&gt;  // one-to-many join
          new OneToManyJoin[PK, R, T, J](this, node, a, joinType)
        case _ =&gt;
          new JoinNode(this, node, joinType).ON(dialect.emptyPredicate)
      }
    }
  def INNER_JOIN[T, J &lt;: Record[T, J]](node: RelationNode[T, J]): JoinNode[PK, R, T, J] =
    JOIN(node, INNER)
  def LEFT_JOIN[T, J &lt;: Record[T, J]](node: RelationNode[T, J]): JoinNode[PK, R, T, J] =
    JOIN(node, LEFT)
  def RIGHT_JOIN[T, J &lt;: Record[T, J]](node: RelationNode[T, J]): JoinNode[PK, R, T, J] =
    JOIN(node, RIGHT)
  def FULL_JOIN[T, J &lt;: Record[T, J]](node: RelationNode[T, J]): JoinNode[PK, R, T, J] =
    JOIN(node, FULL)</code></pre>
        </td>
      </tr>
      <tr id="section-7">
        <td class="docs">
          <h2>Equality &amp; Others</h2>
<p>Two nodes are considered equal if they wrap the same relation and share same aliases.</p>
<p>The <code>hashCode</code> method delegates to node's relation.</p>
<p>The <code>canEqual</code> method indicates that two nodes wrap the same relation.</p>
<p>The <code>clone</code> methods creates a shallow copy of this node (the underlying relation remains unchanged).</p>
<p>Finally, both <code>toSql</code> and <code>toString</code> return dialect specific SQL expression which appends an alias to relation's qualified name.</p>

        </td>
        <td class="code">
          <pre class="scala"><code>  override def equals(that: Any): Boolean = that match {
    case that: RelationNode[_, _] =&gt;
      this.canEqual(that) &amp;&amp; this.alias == that.alias
    case _ =&gt; false
  }

  override def hashCode: Int = relation.hashCode

  def canEqual(that: Any): Boolean = that match {
    case that: RelationNode[_, _] =&gt;
      this.relation == that.relation
  }

  def toSql: String = dialect.alias(relation.qualifiedName, alias)

  override def clone(): this.type = super.clone.asInstanceOf[this.type]

  override def toString: String = toSql
}</code></pre>
        </td>
      </tr>
      <tr id="section-8">
        <td class="docs">
          <p>The <code>ProxyNode</code> wraps a node and provides functionality to arrange joined nodes into a query plan (tree-like structure) by allowing to replace an underlying <code>node</code> with it's equivalent <code>JoinNode</code>. Most methods delegate to underlying <code>node</code>.</p>

        </td>
        <td class="code">
          <pre class="scala"><code>class ProxyNode[PK, R &lt;: Record[PK, R]](protected[orm] var node: RelationNode[PK, R])
    extends RelationNode[PK, R](node.relation) {

  override def alias = node.alias
  override def AS(alias: String): this.type = {
    node.AS(alias)
    return this
  }

  override def projections = node.projections
  override def * = node.*

  override def canEqual(that: Any): Boolean = node.canEqual(that)
  override def equals(obj: Any) = node.equals(obj)
  override def hashCode = node.hashCode

  override def toSql = node.toSql

  override def clone(): this.type = {
    val newNode = super.clone().asInstanceOf[this.type]
    val n = node.clone().asInstanceOf[RelationNode[PK, R]]
    newNode.node = n
    return newNode
  }

}</code></pre>
        </td>
      </tr>
      <tr id="section-9">
        <td class="docs">
          <h1>Joins</h1>
<p>Relations can be joined within one query to allow applying restrictions on associated relations. The <code>JoinNode</code> class represents a join between two relations. We stick to a general convention called <em>left associativity</em>: two joined nodes with equal left nodes are considered equal:</p>
<pre><code>(ci JOIN co) == ci
(ci JOIN co JOIN ca) == ((ci JOIN co) JOIN ca)</code></pre>
<p>This way you can compose arbitrary complex query plans. The join condition (the <code>ON</code> subclause) can be either inferred from associations or specified manually using the <code>ON</code> method.</p>

        </td>
        <td class="code">
          <pre class="scala"><code>class JoinNode[PKL, L &lt;: Record[PKL, L], PKR, R &lt;: Record[PKR, R]](
    protected var _left: RelationNode[PKL, L],
    protected var _right: RelationNode[PKR, R],
    protected var _joinType: JoinType) extends ProxyNode[PKL, L](_left) {

  def left = _left
  def right = _right
  def joinType = _joinType

  protected var _on: String = &quot;&quot;
  def on = _on
  def ON(condition: String): this.type = {
    _on = condition
    return this
  }

  def sqlOn = dialect.on(this.on)

  override def projections = left.projections ++ right.projections

  def replaceLeft(newLeft: RelationNode[PKL, L]): this.type = {
    this._left = newLeft
    return this
  }

  def replaceRight(newRight: RelationNode[PKR, R]): this.type = {
    this._right = newRight
    return this
  }

  override def toSql = dialect.join(this)

  override def clone(): this.type = super.clone()
      .replaceLeft(this.left.clone)
      .replaceRight(this.right.clone)

  override def toString = &quot;(&quot; + left + &quot; -&gt; &quot; + right + &quot;)&quot;

}

class ManyToOneJoin[PKL, L &lt;: Record[PKL, L], PKR, R &lt;: Record[PKR, R]](
    childNode: RelationNode[PKL, L],
    parentNode: RelationNode[PKR, R],
    val association: Association[PKR, L, R],
    joinType: JoinType) extends JoinNode[PKL, L, PKR, R](childNode, parentNode, joinType) {
  override def on: String =
    if (_on == &quot;&quot;)
      dialect.qualifyColumn(association.field, childNode.alias) + &quot; = &quot; +
          dialect.qualifyColumn(association.parentRelation.PRIMARY_KEY, parentNode.alias)
    else _on
}

class OneToManyJoin[PKL, L &lt;: Record[PKL, L], PKR, R &lt;: Record[PKR, R]](
    parentNode: RelationNode[PKL, L],
    childNode: RelationNode[PKR, R],
    val association: Association[PKL, R, L],
    joinType: JoinType) extends JoinNode[PKL, L, PKR, R](parentNode, childNode, joinType) {
  override def on: String =
    if (_on == &quot;&quot;)
      dialect.qualifyColumn(association.field, childNode.alias) + &quot; = &quot; +
          dialect.qualifyColumn(association.parentRelation.PRIMARY_KEY, parentNode.alias)
    else _on
}</code></pre>
        </td>
      </tr>
  </table>
</div>

<div id="footer">
  <p><span>Copyright 2009-2010 <a href="http://circumflex.ru">circumflex.ru</a></span></p>
  <p><a href="/license.html">Terms <span class="amp">&amp;</span> conditions</a> apply &bull;
    <a href="/credits.html">credits</a></p>
</div>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-12034468-1");
    pageTracker._setDomainName(".circumflex.ru");
    pageTracker._trackPageview();
  } catch(err) {}</script>
</body>
</html>

